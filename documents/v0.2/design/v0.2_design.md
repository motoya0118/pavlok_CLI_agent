# v0.2 監視型コーチングAgent 設計（実装向け）
更新日: 2026-01-11

## 目的
自身の定義した目標に導くコーチングAgentを実現する。対象者が目標から外れる習慣・考え方に対して適切な抑止力を持てるよう、定期的なリマインド・確認・振り返りを行い、必要に応じてPavlok刺激を与える。

## 前提・制約
- LLMを常時接続し続ける運用は現実的ではないため、**スケジュール駆動**で必要時に起動して即時終了する。
- 日付・時刻はJSTで解釈・保存・判定する（入力/DB/バッチ起動すべてJSTで統一）。
- ユーザーとの対話はSlackを主経路とし、Pavlokは強制力の実装手段として使用する。

## スコープ
### 対象
- スケジュール実行プロセス（LLM起動）
- Slack通知・返信監視
- Pavlok刺激の起動
- 監視イベント/懲罰のDB管理V
- 振り返りレポート生成（LLM）

### 非対象（v0.2では実施しない）
- マルチユーザー/マルチチャンネル対応
- 高度なパーソナライズ学習（強度最適化など）
- リアルタイム常駐監視

## 用語
- **Morning**: 朝のスケジュール調整フロー
- **Remind_ask**: 監視リマインドの質問フロー
- **Reflection**: 夜の振り返りフロー
- **Ignore**: Slack質問に指定時間内に返信がない状態

## 全体構成
### コンポーネント
- **schedule executor（main.py / schedule_executor.py）**
  - 1分おきにDBの`schedules`を読み、LLM実行が必要な行を起動
- **prompts/**
  - `prompt_name`ごとのテンプレート（Morning/Remind_ask/Reflection）
- **skills（scripts/**）
  - Slack / Pavlok / add_schedules / behavior_log / add_slack_ignore_events / repentance
- **DB**
  - 監視イベント・懲罰状態・スケジュール管理

## プロジェクト構成（ディレクトリ責務とファイル配置）
- **ルート直下**
  - `main.py`: エントリポイント（schedule executor起動のみ担当）
  - `schedule_executor.py`: スケジュール実行の本体ロジック
  - `.env`: 実行環境の設定（秘匿情報含む）
  - `env-sample`: 環境変数のサンプル
  - `app.db`: ローカルSQLite（開発/単一運用想定）
  - `README.md`: 使い方/運用手順
- **prompts/**
  - `prompts/morning.md`
  - `prompts/remind_ask.md`
  - `prompts/reflection.md`
  - 命名規則は`schedules.prompt_name`と一致させる
- **scripts/**（スキル実装）
  - `scripts/slack.py`: Slack質問/返信/待機
  - `scripts/pavlok.py`: Pavlok刺激送信（LIMIT系ロジック含む）
  - `scripts/add_schedules.py`: schedules一括登録
  - `scripts/behavior_log.py`: behavior_logs書き込み/読み出し
  - `scripts/add_slack_ignore_events.py`: slack_ignore_events登録 + daily_punishments更新
  - `scripts/repentance.py`: 未消化懲罰の実行（内部でscripts/pavlok.pyを使用）
- **db/**（DBレイヤ）
  - `db/models.py`: SQLAlchemyモデル定義
  - `db/engine.py`: DB接続/セッション
  - `db/alembic/`: マイグレーション管理
  - `db/alembic/versions/*.py`: 変更履歴
- **tests/**（スクリプト単位のテスト）
  - `tests/scripts/test_slack.py`
  - `tests/scripts/test_pavlok.py`
  - `tests/scripts/test_add_schedules.py`
  - `tests/scripts/test_behavior_log.py`
  - `tests/scripts/test_add_slack_ignore_events.py`
  - `tests/scripts/test_repentance.py`
  - `tests/test_schedule_executor.py`
  - `tests/test_main.py`
- **documents/**
  - `documents/v0.2/design/v0.2_design.md`: 実装用設計書（本書）
  - `documents/v0.2/design/v0.2.md`: 仕様サマリ（必要なら）

### データの流れ（概要）
1. Morningプロンプトで当日のリマインド・振り返り・翌朝計画を確定
2. `add_schedules`で当日分のジョブをDB登録
3. schedule executorが時間到達時にプロンプトを起動
4. Slack質問 -> 返信待ち -> 状況に応じて行動
5. 反応がなければ`add_slack_ignore_events`で無視を記録
6. Reflection後に`repentance`で未実行の懲罰を実行

## 実行フロー詳細
### 1) Morning
- 目的: 当日の監視スケジュールを確定する
- 具体的手順
  1. Slackで「今日のリマインド/振り返り/翌朝計画の候補」を提示
  2. ユーザーが調整返信
  3. LLMが最終スケジュールを確定
  4. `add_schedules`でRemind_ask/Reflection/Morning(翌朝)を登録
  5. `behavior_log`に「morning planning完了」などのログを任意で登録

### 2) Remind_ask
- 目的: 悪習慣の有無確認と抑止力
- 具体的手順
  1. Slackで質問
  2. 指定時間内に返信あり → 返信内容を解析
      - 叱責/指導が必要ならPavlokを即時実行
      - 行動ログを`behavior_logs`に記録
  3. 返信なし（Ignore） → `add_slack_ignore_events`で無視を記録
      - 当日振り返り直前に**再リマインド**を登録

### 3) Reflection
- 目的: 日次の振り返りとレポート返信
- 具体的手順
  1. Slackで振り返り依頼
  2. 返信あり → 本日の行動ログ/返信文を要約し日次レポートを返信
  3. 返信なし（Ignore） → `add_slack_ignore_events`で無視を記録
  4. その後`repentance`を実行し、未実行分の懲罰を一括で実施

## スケジュール実行プロセス（schedule executor）
- **初回起動時**:
  - `schedules`に`prompt_name=morning`かつ`state=pending`の予定が1件もない場合、**morningを即時起動**する（例: `scheduled_date=now`で登録し、そのままexecutorで処理）
- **起動頻度**: 1分おき
- **対象条件**:
  - `scheduled_date <= now()`
  - `state in (pending, failed)`
- **処理フロー**
  1. 対象行を取得
  2. 対象行を`running`に更新（排他制御のため）
  3. `prompts/{prompt_name}.md`を読み込み、下記値を埋め込み
     - `input_value`（JSON文字列でも可）
     - `state`, `last_result`, `last_error`
  4. `codex exec {user_prompt}` を実行
  5. 標準出力を`last_result`へ保存
  6. 正常終了なら`state=done`、失敗なら`state=failed`とし`last_error`に理由を保存
  7. 失敗時は`scheduled_date`を`now + RETRY_DELAY_MIN`へ更新して即時リトライループを防止

## プロンプト設計
- **場所**: `prompts/{prompt_name}.md`
- **共通で含める変数**:
  - `input_value`（そのまま挿入）
  - `schedule_id`, `state`, `last_result`, `last_error`
- **出力方針**:
  - 原則として**スキル呼び出しを行い、副作用はDB/外部APIに委譲**
  - LLM自身は状態を持たず、DBに外部状態を残す

## DB設計（v0.2）
※実装用の正規化仕様。v0.2.mdの内容を反映。

### schedules
| column | type | note |
|---|---|---|
| id | integer PK | |
| prompt_name | string | 実行プロンプト識別子（例: morning/remind_ask/reflection） |
| input_value | string | prompt用入力（JSON文字列可） |
| scheduled_date | datetime | 実行予定時刻（JST解釈） |
| state | enum | pending/running/done/failed |
| last_result | text | 前回実行結果（stdout） |
| last_error | text | エラー内容 |
| created_at | datetime | |
| updated_at | datetime | |

### slack_ignore_events
| column | type | note |
|---|---|---|
| id | integer PK | |
| slack_message_ts | string | Slackメッセージts（ユニーク） |
| detected_at | datetime | 無視確定時刻 |
| date | date | 集計日（JST） |
| created_at | datetime | |

### daily_punishments
| column | type | note |
|---|---|---|
| id | integer PK | |
| date | date unique | 対象日 |
| ignore_count | integer | 無視回数の事実集計 |
| punishment_count | integer | 実行すべきPavlok回数 |
| executed_count | integer | 実行済み回数 |
| state | enum | pending/running/done/failed |
| last_executed_at | datetime | |
| created_at | datetime | |
| updated_at | datetime | |

### pavlok_counts
| column | type | note |
|---|---|---|
| id | integer PK | |
| date | date unique | 集計日（JST） |
| zap_count | integer | 当日のzap累計回数 |
| created_at | datetime | |
| updated_at | datetime | |

### behavior_logs
| column | type | note |
|---|---|---|
| id | integer PK | |
| behavior | enum | good/bad |
| related_date | date | 任意（対象日） |
| pavlok_log | json | Pavlok実行結果要約 |
| coach_comment | text | 叱責・助言・要約 |
| created_at | datetime | |

## スキル設計（入出力）
### Slack
- **目的**: 質問投稿・返信監視・スレッド返信
- **入力**
  - `--mode ask|reply`
  - `question`（ask時は質問文、reply時は返信文）
  - `--thread-ts`（reply時に必須）
  - `--timeout`（返信待ち秒）
- **出力（標準出力）**
  - v0.2では**JSON形式に統一**する
  - 例:
    ```json
    {
      "assistant_question": "...",
      "user_answer": "...",
      "is_answer": true,
      "thread_ts": "...",
      "message_ts": "..."
    }
    ```
  - timeout時: `{"assistant_question":"...","user_answer":null,"is_answer":false,"thread_ts":"...","message_ts":"..."}` の形式

### Pavlok
- **目的**: 刺激送信
- **入力**: `stimulusType`, `stimulusValue`, `reason`
- **処理（zapのみ）**:
  - 当日（JST）の`pavlok_counts`をUPSERTして`zap_count`を+1
  - `zap_count`が環境変数`LIMIT_DAY_PAVLOK_COUNTS`を**上回った場合はAPI呼び出しを行わず**に終了
  - `stimulusValue`が環境変数`LIMIT_PAVLOK_ZAP_VALUE`を超える場合は、**上限値に丸めてから**APIをコールする
- **出力**:
  - 通常時: APIレスポンス本文（JSON）
  - zapスキップ時: `{"skipped": true, "reason": "limit_reached", "date": "YYYY-MM-DD", "zap_count": N, "LIMIT_DAY_PAVLOK_COUNTS": M}` 形式のJSON

### add_schedules
- **目的**: schedulesの一括登録
- **入力**: JSON配列
  ```json
  [
    {"prompt_name":"remind_ask","input_value":"...","scheduled_date":"2026-01-11 10:00"}
  ]
  ```
- **出力**: 挿入件数

### behavior_log
- **目的**: 振り返り/叱責ログの追加または参照
- **モード**:
  - `write`: 1レコード追加
    - **必須**: `behavior (good|bad)`
    - **任意**: `--related-date`, `--pavlok-log`, `--coach-comment`
  - `read`: 指定日数分のレコード取得（`created_at`基準）
    - **必須**: `days`（正の整数）
    - `days=1`は「今日のみ」、`days=2`は「今日+昨日」（JST日付境界で集計）
- **出力**:
  - `write`: 追加結果（例: `{"id": 123}`）
  - `read`: レコード一覧JSON（`id`, `behavior`, `related_date`, `pavlok_log`, `coach_comment`, `created_at`）

### add_slack_ignore_events
- **目的**: 無視イベント登録 + daily_punishments更新
- **仕様**
  - 1実行で`slack_ignore_events`を1件追加
  - 同日`daily_punishments`がなければ作成
  - `ignore_count`と`punishment_count`を+1
- **出力**: 未実行レコード全てを対象にした残数合計（`sum(punishment_count - executed_count)`）

### repentance
- **目的**: 未消化の懲罰を実行
- **仕様**
  - `daily_punishments`で`state in (pending, failed)`を対象
  - (`punishment_count - executed_count`)回Pavlokを実行
  - 実行は**必ずpavlokスキル（scripts/pavlok.py）経由**で行い、LIMIT系の共通仕様を適用する
  - Pavlok上限到達やAPI失敗時は`state=failed`とし、`executed_count`は**端末起動回数（API呼び出し試行回数）**のみ加算する
  - 完了後`state=done`、`executed_count=punishment_count`
- **出力**: 実行したPavlok回数

## 状態遷移
### schedules
`pending` → `running` → `done`
`pending`/`running` → `failed` →（再実行）→ `running`

### daily_punishments
`pending` → `running` → `done`
`pending`/`running` → `failed` →（repentance再実行）→ `running`

## 失敗時・リトライ方針
- Slack/Pavlok API失敗時: `schedules.state=failed`にし、`last_error`に内容保存
- 失敗したスケジュールは次回のexecutor起動時に再試行
- 無限ループ防止のため、失敗時は`scheduled_date`を未来にずらす（RETRY_DELAY_MIN）

## テスト方針（スクリプト単位）
- **原則**: `scripts/*.py`ごとに対応する`tests/scripts/test_*.py`を用意し、スクリプト単位での挙動を担保する
- **外部API**: Slack/Pavlokはモック化し、入出力JSONとDB更新の検証に集中する
- **DB**: テスト用SQLite（テンポラリ）を用い、テーブル作成〜更新までを各テスト内で完結させる
- **境界値**: Pavlokの`LIMIT_DAY_PAVLOK_COUNTS`/`LIMIT_PAVLOK_ZAP_VALUE`、timeout、ignore集計の境界を明示的にテストする
- **main/schedule_executor**: 直接呼び出し可能な関数に切り出し、スクリプト起動の副作用は最小限にしてテストする

## 設定値（環境変数/定数）
- `SLACK_BOT_USER_OAUTH_TOKEN`
- `SLACK_USER_OAUTH_TOKEN`（返信取得用、未指定時はBOTトークン）
- `SLACK_CHANNEL`
- `PAVLOK_API_KEY`
- `TIMEZONE=JST`
- `REMIND_TIMEOUT_SEC`
- `REFLECTION_TIMEOUT_SEC`
- `RETRY_DELAY_MIN`
- `PAVLOK_TYPE_REMIND` / `PAVLOK_VALUE_REMIND`
- `PAVLOK_TYPE_PUNISH` / `PAVLOK_VALUE_PUNISH`
- `PUNISH_INTERVAL_SEC`
- `LIMIT_DAY_PAVLOK_COUNTS`
- `LIMIT_PAVLOK_ZAP_VALUE`

## 既存実装との差分（実装上の注意）
- `db/models.py`の`schedules`は`script_name`/`is_execute`ベースなので、v0.2の`prompt_name`/`state`に更新が必要
- `scripts/slack.py`の標準出力は現状JSONではないため、v0.2ではJSONへ変更
- `behavior_logs`に`related_date`/`created_at`が追加される前提
- `daily_punishments`/`slack_ignore_events`は新規テーブル
